<div class="payment-management-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">payments</mat-icon>
      <div class="header-text">
        <h1>Payment Management</h1>
        <p>Manage and track all payment transactions</p>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTabIndex" animationDuration="0ms">
    <!-- All Payments Tab -->
    <mat-tab label="All Payments">
      <!-- Filters Section -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-header">
        <div class="filters-title">
          <mat-icon>filter_list</mat-icon>
          <span>Filter Payments</span>
        </div>
        <button mat-button (click)="clearFilters()" class="clear-filters-btn">
          <mat-icon>restart_alt</mat-icon>
          Reset Filters
        </button>
      </div>

      <div class="filters-grid">
        <div class="filter-group">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilters()">
              <mat-option value="all">
                <mat-icon class="option-icon">check_circle_outline</mat-icon>
                All Statuses
              </mat-option>
              <mat-option value="pending">
                <mat-icon class="option-icon status-pending-icon">schedule</mat-icon>
                Pending
              </mat-option>
              <mat-option value="completed">
                <mat-icon class="option-icon status-completed-icon">check_circle</mat-icon>
                Completed
              </mat-option>
              <mat-option value="record">
                <mat-icon class="option-icon status-recorded-icon">lock</mat-icon>
                Recorded
              </mat-option>
              <mat-option value="failed">
                <mat-icon class="option-icon status-failed-icon">cancel</mat-icon>
                Failed
              </mat-option>
              <mat-option value="refunded">
                <mat-icon class="option-icon status-refunded-icon">undo</mat-icon>
                Refunded
              </mat-option>
            </mat-select>
            <mat-icon matPrefix class="field-icon">assignment</mat-icon>
          </mat-form-field>
        </div>

        <div class="filter-group">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Payment Method</mat-label>
            <mat-select [(ngModel)]="filterMethod" (selectionChange)="applyFilters()">
              <mat-option value="all">
                <mat-icon class="option-icon">payment</mat-icon>
                All Methods
              </mat-option>
              <mat-option value="cash">
                <mat-icon class="option-icon">payments</mat-icon>
                Cash
              </mat-option>
              <mat-option value="bank_transfer">
                <mat-icon class="option-icon">account_balance</mat-icon>
                Bank Transfer
              </mat-option>
              <mat-option value="gcash">
                <mat-icon class="option-icon">phone_android</mat-icon>
                GCash
              </mat-option>
            </mat-select>
            <mat-icon matPrefix class="field-icon">credit_card</mat-icon>
          </mat-form-field>
        </div>

        <div class="filter-group">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Payment Type</mat-label>
            <mat-select [(ngModel)]="filterType" (selectionChange)="applyFilters()">
              <mat-option value="all">
                <mat-icon class="option-icon">category</mat-icon>
                All Types
              </mat-option>
              <mat-option value="court_usage">
                <mat-icon class="option-icon">sports_tennis</mat-icon>
                Court Usage
              </mat-option>
              <mat-option value="membership_fee">
                <mat-icon class="option-icon">card_membership</mat-icon>
                Membership Fee
              </mat-option>
              <mat-option value="tournament_entry">
                <mat-icon class="option-icon">emoji_events</mat-icon>
                Tournament Entry
              </mat-option>
            </mat-select>
            <mat-icon matPrefix class="field-icon">label</mat-icon>
          </mat-form-field>
        </div>

        <div class="filter-group search-group">
          <mat-form-field appearance="outline" class="filter-field search-field" subscriptSizing="dynamic">
            <input matInput [(ngModel)]="searchTerm" (input)="applyFilters()">
            <mat-icon matPrefix class="field-icon">search</mat-icon>
            <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="searchTerm=''; applyFilters()" class="clear-search-btn">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>
      </div>

      <div class="active-filters" *ngIf="filterStatus !== 'all' || filterMethod !== 'all' || filterType !== 'all' || searchTerm">
        <span class="active-filters-label">Active filters:</span>
        <mat-chip *ngIf="filterStatus !== 'all'" class="filter-chip" (removed)="filterStatus='all'; applyFilters()">
          {{ filterStatus }}
          <button matChipRemove><mat-icon>cancel</mat-icon></button>
        </mat-chip>
        <mat-chip *ngIf="filterMethod !== 'all'" class="filter-chip" (removed)="filterMethod='all'; applyFilters()">
          {{ filterMethod === 'bank_transfer' ? 'Bank Transfer' : filterMethod === 'gcash' ? 'GCash' : 'Cash' }}
          <button matChipRemove><mat-icon>cancel</mat-icon></button>
        </mat-chip>
        <mat-chip *ngIf="filterType !== 'all'" class="filter-chip" (removed)="filterType='all'; applyFilters()">
          {{ filterType === 'court_usage' ? 'Court Usage' : filterType === 'membership_fee' ? 'Membership Fee' : 'Tournament Entry' }}
          <button matChipRemove><mat-icon>cancel</mat-icon></button>
        </mat-chip>
        <mat-chip *ngIf="searchTerm" class="filter-chip" (removed)="searchTerm=''; applyFilters()">
          "{{ searchTerm }}"
          <button matChipRemove><mat-icon>cancel</mat-icon></button>
        </mat-chip>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Summary Section -->
  <mat-card class="summary-card">
    <mat-card-content>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Total</div>
          <div class="summary-value">{{ summary.total }} ({{ formatAmount(summary.totalAmount) }})</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Pending</div>
          <div class="summary-value status-pending">{{ summary.pending }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Completed</div>
          <div class="summary-value status-completed">{{ summary.completed }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Recorded</div>
          <div class="summary-value status-recorded">{{ summary.recorded }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Failed</div>
          <div class="summary-value status-failed">{{ summary.failed }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Refunded</div>
          <div class="summary-value status-refunded">{{ summary.refunded }}</div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Payments Table -->
  <mat-card class="table-card">
    <mat-card-content>
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading payments...</p>
      </div>

      <div *ngIf="!isLoading && filteredPayments.length === 0" class="no-data">
        <mat-icon>inbox</mat-icon>
        <p>No payments found</p>
      </div>

      <div *ngIf="!isLoading && filteredPayments.length > 0" class="table-container">
        <table mat-table [dataSource]="paginatedPayments" class="payments-table">
          <!-- Reference Number Column -->
          <ng-container matColumnDef="reference">
            <th mat-header-cell *matHeaderCellDef>Reference</th>
            <td mat-cell *matCellDef="let payment">
              <span class="ref-number">{{ payment.referenceNumber }}</span>
            </td>
          </ng-container>

          <!-- User Column -->
          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef>User</th>
            <td mat-cell *matCellDef="let payment">
              <div class="user-info">
                <span class="user-name">{{ payment.userId.fullName }}</span>
                <span class="user-username">@{{ payment.userId.username }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let payment">
              <div class="amount-container">
                <span class="amount">{{ formatAmount(payment.amount, payment.currency) }}</span>
                <span class="overdue-badge" *ngIf="isOverdue(payment)">
                  Overdue {{ getDaysOverdue(payment) }} {{ getDaysOverdue(payment) === 1 ? 'day' : 'days' }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Method Column -->
          <ng-container matColumnDef="method">
            <th mat-header-cell *matHeaderCellDef>Method</th>
            <td mat-cell *matCellDef="let payment">
              <div class="method-display">
                <mat-icon [matTooltip]="payment.paymentMethod">{{ getMethodIcon(payment.paymentMethod) }}</mat-icon>
                <span>{{ payment.paymentMethod === 'bank_transfer' ? 'Bank' : payment.paymentMethod === 'gcash' ? 'GCash' : 'Cash' }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let payment">
              <mat-chip [class]="getStatusChipClass(payment.status)">
                <mat-icon>{{ getStatusIcon(payment.status) }}</mat-icon>
                {{ payment.status === 'record' ? 'Recorded' : payment.status }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let payment">
              {{ getPaymentTypeLabel(payment.paymentType) }}
              <span *ngIf="payment.membershipYear" class="year-badge">{{ payment.membershipYear }}</span>
            </td>
          </ng-container>

          <!-- Payment Date Column -->
          <ng-container matColumnDef="paymentDate">
            <th mat-header-cell *matHeaderCellDef>Payment Date</th>
            <td mat-cell *matCellDef="let payment">
              {{ formatDate(payment.paymentDate) }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let payment">
              <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionsMenu="matMenu">
                <button mat-menu-item (click)="openEditDialog(payment)" [disabled]="!canEdit(payment)">
                  <mat-icon>edit</mat-icon>
                  <span>Edit Details</span>
                </button>
                <button mat-menu-item (click)="recordPayment(payment)" [disabled]="!canRecord(payment)">
                  <mat-icon>lock</mat-icon>
                  <span>Record Payment</span>
                </button>
                <button mat-menu-item (click)="unrecordPayment(payment)" [disabled]="!canUnrecord(payment)">
                  <mat-icon>lock_open</mat-icon>
                  <span>Unrecord</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <mat-paginator
          [length]="filteredPayments.length"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
    </mat-tab>

    <!-- Overdue Report Tab -->
    <mat-tab label="Overdue Report">
      <mat-card class="overdue-summary-card">
        <mat-card-content>
          <div class="overdue-header">
            <div class="overdue-stats">
              <div class="stat-item">
                <mat-icon>people</mat-icon>
                <div>
                  <div class="stat-label">Members with Overdues</div>
                  <div class="stat-value">{{ overdueSummaries.length }}</div>
                </div>
              </div>
              <div class="stat-item">
                <mat-icon>receipt_long</mat-icon>
                <div>
                  <div class="stat-label">Total Overdue Payments</div>
                  <div class="stat-value">{{ getTotalOverdueCount() }}</div>
                </div>
              </div>
              <div class="stat-item">
                <mat-icon>attach_money</mat-icon>
                <div>
                  <div class="stat-label">Total Overdue Amount</div>
                  <div class="stat-value">{{ formatAmount(getTotalOverdueAmount()) }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="table-card">
        <mat-card-content>
          <div *ngIf="isLoading" class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
            <p>Loading overdue report...</p>
          </div>

          <div *ngIf="!isLoading && overdueSummaries.length === 0" class="no-data">
            <mat-icon>celebration</mat-icon>
            <p>No overdue payments found!</p>
          </div>

          <div *ngIf="!isLoading && overdueSummaries.length > 0" class="table-container">
            <table mat-table [dataSource]="overdueSummaries" class="overdue-table">
              <!-- Member Name Column -->
              <ng-container matColumnDef="fullName">
                <th mat-header-cell *matHeaderCellDef>Member</th>
                <td mat-cell *matCellDef="let member">
                  <div class="user-info">
                    <span class="user-name">{{ member.fullName }}</span>
                    <span class="user-username">@{{ member.username }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Overdue Count Column -->
              <ng-container matColumnDef="overdueCount">
                <th mat-header-cell *matHeaderCellDef>Overdue Payments</th>
                <td mat-cell *matCellDef="let member">
                  <mat-chip class="count-chip">{{ member.overdueCount }}</mat-chip>
                </td>
              </ng-container>

              <!-- Total Overdue Amount Column -->
              <ng-container matColumnDef="totalOverdueAmount">
                <th mat-header-cell *matHeaderCellDef>Total Amount</th>
                <td mat-cell *matCellDef="let member">
                  <span class="overdue-amount">{{ formatAmount(member.totalOverdueAmount) }}</span>
                </td>
              </ng-container>

              <!-- Oldest Overdue Days Column -->
              <ng-container matColumnDef="oldestOverdueDays">
                <th mat-header-cell *matHeaderCellDef>Oldest Overdue</th>
                <td mat-cell *matCellDef="let member">
                  <div class="overdue-days">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <span>{{ member.oldestOverdueDays }} {{ member.oldestOverdueDays === 1 ? 'day' : 'days' }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let member">
                  <button mat-stroked-button color="primary" (click)="viewMemberOverdueDetails(member)">
                    <mat-icon>visibility</mat-icon>
                    View Details
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="overdueDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: overdueDisplayedColumns;"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-tab>
  </mat-tab-group>
</div>
